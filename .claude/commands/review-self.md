---
allowed-tools: Read, Glob, Grep, Write(~/tmp/claude-dev/**), Bash(git log *), Bash(git diff *), Bash(git rev-parse *), Bash(git merge-base *), Bash(git branch *), Bash(mkdir *)
description: コミット範囲を自己レビューし、品質問題を検出する
---

# セルフレビューコマンド

指定されたコミット範囲のコード変更を分析し、品質上の問題を検出します。問題が見つかった場合は修正タスクリストを生成し、ralph-loop で再修正できるようにします。

## 引数の解析

`$ARGUMENT` をスペース区切りで解析:

| 引数 | 必須 | 説明 | デフォルト |
|------|------|------|-----------|
| 第1引数 | - | コミット範囲 | 自動検出 |
| 第2引数 | - | 修正タスクリストの出力パス | `~/tmp/claude-dev/{プロジェクト名}/review-fixes.md` |

### コミット範囲の自動検出

第1引数が省略された場合:
1. 現在のブランチとデフォルトブランチ（main/master）の分岐点を検出
2. 分岐点から HEAD までの全コミットを対象とする
3. デフォルトブランチ上にいる場合は直近 5 コミットを対象とする

## 実行フロー

### Step 1: 対象コミットの特定

1. コミット範囲を確定する（引数または自動検出）
2. `git log --oneline {範囲}` で対象コミット一覧を表示
3. `git diff {範囲}` で変更の全体差分を取得

### Step 2: 変更ファイルの読み込み

変更されたファイルの**現在の内容**を読み込む（差分だけでなく、変更後のファイル全体を確認することで、コンテキストを把握する）。

### Step 3: レビュー観点のチェック

以下の観点で変更を分析する:

#### セキュリティ
- ハードコードされた秘密情報（API キー、パスワード、トークン）
- SQL インジェクション、XSS、コマンドインジェクションの脆弱性
- 不適切な入力バリデーション
- 安全でない暗号化やハッシュの使用

#### コード品質
- 明らかなバグ（off-by-one エラー、null 参照、未処理の例外）
- エラーハンドリングの欠如（外部 API 呼び出し、ファイル I/O 等）
- リソースリーク（未クローズのコネクション、ファイルハンドル）
- 不整合な命名やコーディングスタイル（プロジェクトの既存規約と比較）

#### テスト
- 新機能に対するテストの有無
- エッジケースのカバー不足
- テストが実際に意味のあるアサーションをしているか

#### アーキテクチャ
- 単一責任原則の違反（1つの関数/クラスが多くの責務を持ちすぎていないか）
- 循環依存
- プロジェクトの既存アーキテクチャパターンとの不整合

### Step 4: 結果の報告

レビュー結果を以下の形式で表示する:

```
═══ セルフレビュー結果 ═══

対象: {コミット範囲} ({N} コミット, {M} ファイル変更)

## 問題なし ✓
- {チェック済みで問題のなかった項目}

## 要修正（致命的）
- {ファイル}:{行} - {問題の説明}

## 要修正（重要）
- {ファイル}:{行} - {問題の説明}

## 提案（軽微）
- {ファイル}:{行} - {改善の提案}

---
致命的: {N} / 重要: {N} / 軽微: {N}
```

### Step 5: 修正タスクリスト生成（問題がある場合）

「致命的」または「重要」の問題が 1 つ以上ある場合:

1. 修正タスクリストを生成する
2. 形式は decompose.md の出力と同じ Markdown チェックリスト
3. 各タスクには問題の場所（ファイル:行）と修正方針を記載

```markdown
# セルフレビュー修正タスク

> レビュー対象: {コミット範囲}
> 生成日: {YYYY-MM-DD}

## タスク
- [ ] {ファイル}:{行} - {具体的な修正内容}
...
```

4. 出力パスを表示し、ralph-loop での実行コマンド例を案内

### Step 6: 問題がない場合

全チェックで問題が見つからなかった場合:
- 「問題は検出されませんでした」と報告
- 修正タスクリストは生成しない

## ルール

- **変更のコンテキストを理解する**: 差分だけでなく、変更後のファイル全体を読む
- **プロジェクト規約を基準にする**: 一般的なベストプラクティスよりも、プロジェクトの既存パターンを優先する
- **誤検出を避ける**: 確信のない問題は「提案（軽微）」として報告し、致命的・重要には含めない
- **修正可能な問題のみ報告**: 設計方針への意見や好みの問題は報告しない
